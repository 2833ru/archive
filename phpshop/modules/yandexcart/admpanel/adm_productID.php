<?php

function addYandexcartCPA($data) {
    global $PHPShopGUI;

    $PHPShopGUI->addJSFiles('../modules/yandexcart/admpanel/gui/yandexcart.gui.js');

    $PHPShopOrm = new PHPShopOrm($GLOBALS['SysValue']['base']['yandexcart']['yandexcart_system']);
    $options = $PHPShopOrm->select();

    $Tab3 = '';
    if($options['model'] === 'DBS') {
        $Tab3 .=  $PHPShopGUI->setField('CPA модель',
            $PHPShopGUI->setRadio('cpa_new', 1,'Включить', $data['cpa']) .
            $PHPShopGUI->setRadio('cpa_new', 0,'Выключить', $data['cpa']) .
            $PHPShopGUI->setRadio('cpa_new', 2,'Не использовать CPA', $data['cpa'], false, 'text-muted')
        );
    }

    // Валюты
    $PHPShopValutaArray = new PHPShopValutaArray();
    $valuta_array = $PHPShopValutaArray->getArray();
    if (is_array($valuta_array))
        foreach ($valuta_array as $val) {
            if ($data['baseinputvaluta'] == $val['id']) {
                $valuta_def_name = $val['code'];
            }
        }

    if((int) $data['yml'] === 1) {
        $Tab3 .= $PHPShopGUI->setField('Цена Яндекс.Маркет DBS', $PHPShopGUI->setInputText(null, 'price_yandex_dbs_new', $data['price_yandex_dbs'], 150, $valuta_def_name), 2);
    }
    if((int) $data['sbermarket'] === 1) {
        $Tab3 .= $PHPShopGUI->setField('Цена СберМаркет', $PHPShopGUI->setInputText(null, 'price_sbermarket_new', $data['price_sbermarket'], 150, $valuta_def_name), 2);
    }

    $Tab3 .= $PHPShopGUI->setField("Модель", $PHPShopGUI->setInputText(null, 'model_new', $data['model'], 300), 1, 'Тег model');
    $Tab3 .= $PHPShopGUI->setField('Гарантия', $PHPShopGUI->setRadio('manufacturer_warranty_new', 1, 'Включить', $data['manufacturer_warranty']) . $PHPShopGUI->setRadio('manufacturer_warranty_new', 2, 'Выключить', $data['manufacturer_warranty'], false, 'text-muted'), 1, 'Тег manufacturer_warranty');

    $Tab3 .= $PHPShopGUI->setField("Имя производителя", $PHPShopGUI->setInputText(null, 'vendor_name_new', $data['vendor_name'], 300), 1, 'Тег vendor');

    $Tab3 .= $PHPShopGUI->setField("Код производителя", $PHPShopGUI->setInputText(null, 'vendor_code_new', $data['vendor_code'], 300), 1, 'Тег vendorCode');

    $Tab3 .= $PHPShopGUI->setField("Компания производитель, адрес и рег. номер (если есть)", $PHPShopGUI->setInputText(null, 'manufacturer_new', $data['manufacturer'], 300), 1, 'Тег manufacturer');
    
    $Tab3 .= $PHPShopGUI->setField("Штрихкод", $PHPShopGUI->setInputText(null, 'barcode_new', $data['barcode'], 300), 1, 'Тег barcode');

    $Tab3 .= $PHPShopGUI->setField("Комментарий", $PHPShopGUI->setInputText(null, 'sales_notes_new', $data['sales_notes'], 300), 1, 'Тег sales_notes');

    $Tab3 .= $PHPShopGUI->setField("Страна производства", $PHPShopGUI->setInputText(null, 'country_of_origin_new', $data['country_of_origin'], 300), 1, 'Тег country_of_origin');

    $Tab3 .= $PHPShopGUI->setField("Идентификатор товара на Яндексе", $PHPShopGUI->setInputText(null, 'market_sku_new', $data['market_sku'], 300), 1, 'Тег market-sku для модели FBS, можно получить в личном кабинете Яндекс.Маркета');

    $Tab3 .= $PHPShopGUI->setField('Товар для взрослых', $PHPShopGUI->setRadio('adult_new', 1, 'Включить', $data['adult']) . $PHPShopGUI->setRadio('adult_new', 2, 'Выключить', $data['adult'], false, 'text-muted'), 1, 'Тег adult');

    $condition[] = array(__('Новый товар'), 1, $data['yandex_condition']);
    $condition[] = array(__('Как новый'), 2, $data['yandex_condition']);
    $condition[] = array(__('Подержанный'), 3, $data['yandex_condition']);

    $Tab3 .= $PHPShopGUI->setField('Состояние товара', $PHPShopGUI->setSelect('yandex_condition_new', $condition,300), 1, 'Тег condition');
    
    $Tab3 .= $PHPShopGUI->setField('Причина уценки', $PHPShopGUI->setTextarea('yandex_condition_reason_new', $data['yandex_condition_reason']), 1, 'Тег reason');

    $Tab3 .= $PHPShopGUI->setField('Курьерская доставка', $PHPShopGUI->setRadio('delivery_new', 1, 'Включить', $data['delivery']) . $PHPShopGUI->setRadio('delivery_new', 2, 'Выключить', $data['delivery'], false, 'text-muted'), 1, 'Тег delivery');

    $Tab3 .= $PHPShopGUI->setField('Самовывоз', $PHPShopGUI->setRadio('pickup_new', 1, 'Включить', $data['pickup']) . $PHPShopGUI->setRadio('pickup_new', 2, 'Выключить', $data['pickup'], false, 'text-muted'), 1, 'Тег pickup');

    $Tab3 .= $PHPShopGUI->setField('Покупка в розничном магазине', $PHPShopGUI->setRadio('store_new', 1, 'Включить', $data['store']) . $PHPShopGUI->setRadio('store_new', 2, 'Выключить', $data['store'], false, 'text-muted'), 1, 'Тег store');

    $Tab3 .= $PHPShopGUI->setField("Минимальное количество", $PHPShopGUI->setInputText(null, 'yandex_min_quantity_new', $data['yandex_min_quantity'], 100), 1, ' Минимальное количество товара в одном заказе');

    $Tab3 .= $PHPShopGUI->setField("Минимальный шаг", $PHPShopGUI->setInputText(null, 'yandex_step_quantity_new', $data['yandex_step_quantity'], 100), 1, ' Количество товара, добавляемое к минимальному');
    $Tab3 .= $PHPShopGUI->setField('<a href="/rss/google.php" target="_blank" title="Открыть файл">Google Merchant</a>', $PHPShopGUI->setCheckbox('google_merchant_new', 1, 'Вывод в Google Merchant', $data['google_merchant']));
    $Tab3 .= $PHPShopGUI->setField('<a href="/yml/?cdek" target="_blank" title="Открыть файл">СДЭК.МАРКЕТ</a>', $PHPShopGUI->setCheckbox('cdek_new', 1, 'Вывод в СДЭК.МАРКЕТ', $data['cdek']));
    $Tab3 .= $PHPShopGUI->setField('<a href="/yml/?aliexpress" target="_blank" title="Открыть файл">AliExpress</a>', $PHPShopGUI->setCheckbox('aliexpress_new', 1, 'Вывод в AliExpress', $data['aliexpress']));
    $Tab3 .= $PHPShopGUI->setField('<a href="/yml/?sbermarket" target="_blank" title="Открыть файл">СберМаркет</a>', $PHPShopGUI->setCheckbox('sbermarket_new', 1, 'Вывод в СберМаркет', $data['sbermarket']));

    $PHPShopGUI->addTab(array("Яндекс", $Tab3, true));
}

function updateYandexCart($product) {
    if(empty($_POST['google_merchant_new'])) {
        $_POST['google_merchant_new'] = 0;
    }
    if(empty($_POST['cdek_new'])) {
        $_POST['cdek_new'] = 0;
    }
    if(empty($_POST['aliexpress_new'])) {
        $_POST['aliexpress_new'] = 0;
    }
    if(empty($_POST['sbermarket_new'])) {
        $_POST['sbermarket_new'] = 0;
    }
}

function addYandexCartOptions($data) {
    global $PHPShopGUI;

    $PHPShopGUI->field_col = 3;

    $Tab = $PHPShopGUI->setField("Штрихкод", $PHPShopGUI->setInputText(null, 'barcode_new', $data['barcode'], 300), 1, 'Тег barcode');
    $Tab .= $PHPShopGUI->setField("Код производителя", $PHPShopGUI->setInputText(null, 'vendor_code_new', $data['vendor_code'], 300), 1, 'Тег vendorCode');

    $PHPShopGUI->addTab(["Яндекс", $Tab, true]);
}

$addHandler = array(
    'actionStart' => 'addYandexcartCPA',
    'actionDelete' => false,
    'actionUpdate' => 'updateYandexCart',
    'actionOptionEdit' => 'addYandexCartOptions'
);
?>